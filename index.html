<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>Al-Qur'an App ‚Äî Mushaf Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Amiri+Quran&family=Scheherazade+New:wght@400;700&display=swap" rel="stylesheet">
  <style>
    .font-quran { 
      font-family: 'Amiri Quran', 'Scheherazade New', serif; 
      font-size: 1.55rem; 
      line-height: 2.4rem; 
    }
    .mushaf-page { 
      max-height: 60vh; 
      overflow: auto; 
      padding-right: 8px; 
    }
    .ayat-num { 
      font-size: 0.8rem; 
      opacity: .7; 
    }
    /* simple spinner */
    .spinner { 
      border: 4px solid rgba(0,0,0,0.06); 
      border-top-color: rgba(0,0,0,0.4); 
      border-radius: 50%; 
      width: 36px; 
      height: 36px; 
      animation: spin 1s linear infinite; 
      margin: auto; 
    }
    @keyframes spin { 
      to { transform: rotate(360deg); } 
    }
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .font-quran { font-size: 1.35rem; line-height: 2.1rem; }
      .mushaf-container { flex-direction: column; }
      .mushaf-sidebar { width: 100%; margin-top: 1rem; }
      .control-group { flex-wrap: wrap; }
      .control-group > * { margin-bottom: 0.5rem; }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-gray-100 to-gray-200 text-gray-800 min-h-screen dark:bg-gradient-to-br dark:from-gray-800 dark:to-gray-900 dark:text-gray-200">
  <div class="max-w-4xl mx-auto p-4 md:p-6">
    <header class="flex flex-wrap items-center justify-between mb-6 gap-2">
      <h1 class="text-xl md:text-2xl font-bold text-indigo-700 dark:text-indigo-400">üìñ Al-Qur'an App ‚Äî Mushaf Viewer</h1>
      <div class="flex gap-2 items-center flex-wrap">
        <button id="toggleTheme" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600" aria-label="Toggle dark mode">üåô</button>
        <button id="openMushaf" class="px-3 py-1 rounded bg-indigo-600 text-white hover:bg-indigo-700">üìñ Baca Qur'an</button>
        <button id="openCari" class="px-3 py-1 rounded bg-blue-600 text-white hover:bg-blue-700">üîé Cari</button>
      </div>
    </header>

    <!-- Container utama -->
    <main id="app" class="bg-white rounded-2xl shadow p-4 md:p-5 dark:bg-gray-800">
      <!-- Area dynamic: default cari/hasil dulu -->
      <section id="panel-cari">
        <h2 class="font-semibold text-lg mb-3 text-blue-700 dark:text-blue-400">Cari Ayat</h2>
        <div class="flex flex-wrap gap-3 mb-3">
          <div class="w-full md:w-auto">
            <label for="surah" class="block text-sm mb-1">Surah</label>
            <input id="surah" type="number" min="1" max="114" placeholder="Nomor (1-114)" class="border p-2 rounded w-full md:w-32" />
          </div>
          <div class="w-full md:w-auto">
            <label for="ayat" class="block text-sm mb-1">Ayat</label>
            <input id="ayat" type="number" min="1" placeholder="Nomor ayat" class="border p-2 rounded w-full md:w-32" />
          </div>
          <div class="w-full md:w-auto flex items-end">
            <button id="btnCari" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">üîç Cari</button>
          </div>
          <div class="w-full md:w-auto flex items-end">
            <button id="btnRandom" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">üé≤ Random</button>
          </div>
        </div>

        <div class="flex flex-wrap gap-3 mb-4">
          <div class="w-full md:flex-1">
            <label for="keyword" class="block text-sm mb-1">Cari berdasarkan kata kunci</label>
            <input id="keyword" type="text" placeholder="Contoh: sabar" class="border p-2 rounded w-full" />
          </div>
          <div class="w-full md:w-auto flex items-end">
            <button id="btnCariKata" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 w-full md:w-auto">Cari Kata</button>
          </div>
        </div>

        <div id="output" class="bg-gray-50 p-4 rounded min-h-[120px] dark:bg-gray-700">
          <p class="text-sm text-gray-500 dark:text-gray-400">Hasil akan muncul di sini.</p>
        </div>

        <div class="mt-4 flex gap-2">
          <button id="btnLihatRiwayat" class="px-3 py-1 bg-yellow-500 rounded text-white hover:bg-yellow-600">Riwayat</button>
          <button id="btnBukaFavorit" class="px-3 py-1 bg-pink-500 rounded text-white hover:bg-pink-600">Favorit</button>
        </div>
      </section>

      <!-- Mushaf Viewer (hidden awalnya) -->
      <section id="panel-mushaf" class="hidden">
        <div class="flex flex-wrap items-center justify-between mb-3 gap-3">
          <div class="flex flex-wrap items-center gap-3 control-group">
            <select id="selectSurah" class="border p-2 rounded dark:bg-gray-700"></select>
            <div class="flex items-center">
              <input id="ayatPerPage" type="number" min="1" max="20" value="8" class="border p-2 rounded w-24 dark:bg-gray-700" title="Jumlah ayat per halaman" />
            </div>
            <label class="flex items-center gap-2">
              <input id="toggleTerjemah" type="checkbox" checked />
              <span class="text-sm">Tampilkan Terjemahan</span>
            </label>
          </div>
          <div class="flex flex-wrap items-center gap-2 control-group">
            <button id="bookmarkPage" title="Tambahkan ke favorit" class="px-3 py-1 rounded bg-pink-500 text-white hover:bg-pink-600">‚òÖ Favorit</button>
            <button id="btnAutoPlay" class="px-3 py-1 rounded bg-indigo-600 text-white hover:bg-indigo-700">‚ñ∂ AutoPlay</button>
            <button id="closeMushaf" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600">‚úñ Tutup</button>
          </div>
        </div>

        <div class="border rounded p-4 flex flex-col md:flex-row gap-4 mushaf-container">
          <!-- Halaman mushaf kiri -->
          <div class="flex-1">
            <div class="mushaf-page bg-white p-3 rounded dark:bg-gray-700" id="mushafContentLeft"></div>
            <div class="flex flex-wrap items-center justify-between mt-3">
              <div class="text-sm text-gray-600 dark:text-gray-400" id="pageInfoLeft"></div>
              <div class="flex gap-2 mt-2 md:mt-0">
                <button id="prevPage" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600">‚¨ÖÔ∏è Sebelumnya</button>
                <button id="nextPage" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600">‚û°Ô∏è Selanjutnya</button>
              </div>
            </div>
          </div>

          <!-- Panel kanan: kontrol & info -->
          <aside class="w-full md:w-80 mushaf-sidebar">
            <div class="bg-gray-50 p-3 rounded mb-3 dark:bg-gray-700">
              <h3 class="font-semibold">Info Surah</h3>
              <div id="surahMeta" class="text-sm text-gray-700 dark:text-gray-300 mt-2">‚Äî</div>
            </div>

            <div class="bg-gray-50 p-3 rounded mb-3 dark:bg-gray-700">
              <h3 class="font-semibold">Progress</h3>
              <div class="mt-2">
                <div id="progressText" class="text-sm text-gray-700 dark:text-gray-300">Belum ada data.</div>
                <div class="w-full bg-gray-200 rounded h-2 mt-2 dark:bg-gray-600">
                  <div id="progressBar" class="bg-indigo-600 h-2 rounded" style="width:0%"></div>
                </div>
              </div>
            </div>

            <div class="bg-gray-50 p-3 rounded dark:bg-gray-700">
              <h3 class="font-semibold">Riwayat & Favorit</h3>
              <div class="mt-2 text-sm">
                <button id="gotoLast" class="w-full mb-2 px-2 py-1 bg-yellow-400 rounded hover:bg-yellow-500 dark:bg-yellow-600 dark:hover:bg-yellow-700">üîÅ Lanjutkan dari terakhir</button>
                <button id="listFav" class="w-full mb-2 px-2 py-1 bg-pink-400 rounded hover:bg-pink-500 dark:bg-pink-600 dark:hover:bg-pink-700">‚òÖ Lihat Favorit</button>
                <button id="clearBookmarks" class="w-full px-2 py-1 bg-red-400 rounded text-white hover:bg-red-500 dark:bg-red-600 dark:hover:bg-red-700">Hapus Favorit</button>
              </div>
            </div>
          </aside>
        </div>
      </section>

      <!-- Modal sederhana -->
      <div id="modal" class="fixed inset-0 hidden items-center justify-center bg-black/40 z-50 p-4">
        <div class="bg-white rounded p-4 w-full max-w-xl max-h-[80vh] overflow-auto dark:bg-gray-800">
          <div id="modalContent"></div>
          <div class="text-right mt-3">
            <button id="modalClose" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600">Tutup</button>
          </div>
        </div>
      </div>

      <!-- Spinner area -->
      <div id="loader" class="hidden py-4 text-center">
        <div class="spinner"></div>
        <div class="text-sm text-gray-500 dark:text-gray-400 mt-2">‚è≥ Memuat...</div>
      </div>

    </main>
  </div>

<script>
/* Improved Al-Qur'an App ‚Äî patched script
   Replaces previous <script> block. Paste in place. */
const state = {
  surahList: [],
  currentSurah: null,
  surahDataCache: {}, // key: surahNumber => full surah data (meta + ayahs)
  cacheOrder: [], // track LRU order of cached surah numbers
  currentPageIndex: 0,
  ayatPerPage: 8,
  showTranslation: true,
  autoplay: false,
  autoplayQueue: [],
  autoplayIndex: 0,
  audioEl: new Audio(),
  history: [],
  favorites: [],
  lastPos: null,
  themeDark: false,
  loadingCount: 0, // allow nested loads
  currentPlayingBtn: null, // reference to DOM button currently showing "Playing"
  searchDebounceTimer: null
};

// DOM refs
const panelCari = document.getElementById('panel-cari');
const panelMushaf = document.getElementById('panel-mushaf');
const selectSurah = document.getElementById('selectSurah');
const mushafContentLeft = document.getElementById('mushafContentLeft');
const pageInfoLeft = document.getElementById('pageInfoLeft');
const surahMeta = document.getElementById('surahMeta');
const progressText = document.getElementById('progressText');
const progressBar = document.getElementById('progressBar');
const loader = document.getElementById('loader');
const modal = document.getElementById('modal');
const modalContent = document.getElementById('modalContent');
const output = document.getElementById('output');
const ayatPerPageInput = document.getElementById('ayatPerPage');

// ---------- Utilities ----------
function escapeHtml(unsafe){
  if(unsafe == null) return '';
  return String(unsafe)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'", '&#39;');
}

function showLoader(show = true){
  // nested loads supported
  state.loadingCount += show ? 1 : -1;
  state.loadingCount = Math.max(0, state.loadingCount);
  loader.classList.toggle('hidden', state.loadingCount === 0);

  // disable network-related controls only
  const networkControls = [
    'btnCari','btnRandom','btnCariKata','openMushaf','openCari','bookmarkPage',
    'btnAutoPlay','nextPage','prevPage','btnLihatRiwayat','btnBukaFavorit'
  ];
  networkControls.forEach(id => {
    const el = document.getElementById(id);
    if(!el) return;
    if(state.loadingCount>0){
      el.setAttribute('disabled','disabled');
      el.setAttribute('aria-disabled','true');
    } else {
      el.removeAttribute('disabled');
      el.setAttribute('aria-disabled','false');
    }
  });
}

function showModal(text, opts = { allowHtml: false }){
  // safe: escape by default
  if(opts.allowHtml){
    modalContent.innerHTML = text;
  } else {
    modalContent.textContent = text;
  }
  modal.classList.remove('hidden');
  modal.style.display = 'flex';
}
function closeModal(){
  modal.classList.add('hidden');
  modal.style.display = 'none';
  modalContent.innerHTML = '';
}
document.getElementById('modalClose').onclick = closeModal;
modal.addEventListener('click', (e)=>{ if(e.target===modal) closeModal(); });

// Theme
function applyTheme(){
  state.themeDark = Boolean(localStorage.getItem('quran_dark') === '1' || state.themeDark);
  if(state.themeDark) document.documentElement.classList.add('dark');
  else document.documentElement.classList.remove('dark');
  localStorage.setItem('quran_dark', state.themeDark ? '1' : '0');
  document.getElementById('toggleTheme').textContent = state.themeDark ? '‚òÄÔ∏è' : 'üåô';
}
document.getElementById('toggleTheme').addEventListener('click', ()=>{
  state.themeDark = !state.themeDark;
  applyTheme();
});

// ---------- LocalStorage safe helpers ----------
function safeGetJSON(key, fallback = null){
  try {
    const v = localStorage.getItem(key);
    if(!v) return fallback;
    return JSON.parse(v);
  } catch (e) {
    console.warn('LocalStorage parse error for', key, e);
    return fallback;
  }
}
function safeSetJSON(key, val){
  try {
    localStorage.setItem(key, JSON.stringify(val));
  } catch(e){
    console.warn('LocalStorage set error', key, e);
  }
}

// ---------- Surah list ----------
async function loadSurahList(){
  showLoader(true);
  try {
    const cached = safeGetJSON('quran_surahlist_v2', null);
    if(cached && Array.isArray(cached)){
      state.surahList = cached;
      populateSurahSelect();
      return;
    }
    const res = await fetch('https://api.alquran.cloud/v1/surah');
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const json = await res.json();
    if(json && json.data){
      state.surahList = json.data;
      safeSetJSON('quran_surahlist_v2', state.surahList);
      populateSurahSelect();
    } else {
      throw new Error('Invalid surah list response');
    }
  } catch(e){
    console.error(e);
    showModal('Gagal memuat daftar surah. Cek koneksi.', {allowHtml:false});
  } finally {
    showLoader(false);
  }
}
function populateSurahSelect(){
  selectSurah.innerHTML = '';
  state.surahList.forEach(s=>{
    const opt = document.createElement('option');
    opt.value = s.number;
    opt.textContent = `${s.number}. ${s.englishName} (${s.name}) [${s.numberOfAyahs} ayat]`;
    selectSurah.appendChild(opt);
  });
}

// ---------- Surah data loader (with caching & fallback) ----------
function ensureCacheLimit(max=5){
  // keep most recent 'max' entries
  while(state.cacheOrder.length > max){
    const removeKey = state.cacheOrder.shift();
    delete state.surahDataCache[removeKey];
  }
}

async function loadSurahData(surahNumber){
  surahNumber = Number(surahNumber);
  if(!surahNumber || surahNumber < 1 || surahNumber > 114) throw new Error('Nomor surah invalid');
  if(state.surahDataCache[surahNumber]) {
    // mark as recently used
    const idx = state.cacheOrder.indexOf(surahNumber);
    if(idx !== -1){ state.cacheOrder.splice(idx,1); }
    state.cacheOrder.push(surahNumber);
    return state.surahDataCache[surahNumber];
  }

  showLoader(true);
  try {
    const url = `https://api.alquran.cloud/v1/surah/${surahNumber}/editions/quran-uthmani,id.indonesian,ar.alafasy`;
    const res = await fetch(url);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const json = await res.json();
    if(!json || !json.data || json.data.length===0) {
      throw new Error('No data for surah');
    }

    // Find editions with fallback
    const findEdition = (identifierPart) => json.data.find(d => d.edition && d.edition.identifier && d.edition.identifier.includes(identifierPart));
    const arab = findEdition('quran-uthmani') || json.data[0];
    const indo = findEdition('indonesian') || json.data.find(d=>d.edition && d.edition.language && d.edition.language.startsWith('id')) || null;
    const audio = findEdition('alafasy') || json.data.find(d=>d.edition && d.edition.type && d.edition.type === 'audio') || null;

    if(!arab || !arab.ayahs) throw new Error('Invalid arabic data');

    const ayahs = arab.ayahs.map((a, idx)=>({
      number: a.number,
      numberInSurah: a.numberInSurah,
      textArab: a.text,
      textId: (indo && indo.ayahs && indo.ayahs[idx]) ? indo.ayahs[idx].text : '',
      audio: (audio && audio.ayahs && audio.ayahs[idx]) ? audio.ayahs[idx].audio : null
    }));

    const meta = {
      number: arab.number,
      name: arab.englishName,
      nameLocal: arab.name,
      numberOfAyahs: arab.numberOfAyahs,
      revelationType: arab.revelationType,
      ayahs
    };

    state.surahDataCache[surahNumber] = meta;
    state.cacheOrder.push(surahNumber);
    ensureCacheLimit(5);
    return meta;
  } catch(e){
    console.error(e);
    showModal(`Gagal memuat surah ${surahNumber}.`, {allowHtml:false});
    throw e;
  } finally {
    showLoader(false);
  }
}

// ---------- Rendering ----------
async function renderMushafPage(surahNumber, pageIndex){
  try {
    const meta = await loadSurahData(surahNumber);
    state.currentSurah = meta.number;
    state.currentPageIndex = pageIndex;
    const per = state.ayatPerPage;
    const totalPages = Math.ceil(meta.numberOfAyahs / per);
    if(pageIndex < 0 || pageIndex >= totalPages){
      mushafContentLeft.innerHTML = `<p class="text-sm text-gray-500">Halaman tidak valid.</p>`;
      return;
    }
    const start = pageIndex * per;
    const chunk = meta.ayahs.slice(start, start + per);

    mushafContentLeft.innerHTML = '';
    if(chunk.length===0){
      mushafContentLeft.innerHTML = `<p class="text-sm text-gray-500">Tidak ada ayat di halaman ini.</p>`;
    } else {
      chunk.forEach(a=>{
        const ayEl = document.createElement('div');
        ayEl.className = 'mb-4 p-2 border-b dark:border-gray-600';
        // use escaped text for translation but arabic text is safe to inject as text node
        const arabDiv = document.createElement('div');
        arabDiv.className = 'font-quran text-right';
        arabDiv.textContent = a.textArab;
        ayEl.appendChild(arabDiv);
        if(state.showTranslation){
          const tr = document.createElement('div');
          tr.className = 'mt-2 text-sm text-gray-700 dark:text-gray-300';
          tr.textContent = a.textId || '';
          ayEl.appendChild(tr);
        }
        const metaRow = document.createElement('div');
        metaRow.className = 'mt-2 flex items-center gap-2';
        const numDiv = document.createElement('div');
        numDiv.className = 'ayat-num';
        numDiv.textContent = `Surah ${meta.name} (${meta.nameLocal}) ‚Äî Ayat ${a.numberInSurah}`;
        metaRow.appendChild(numDiv);

        if(a.audio){
          const btn = document.createElement('button');
          btn.className = 'playAyat px-2 py-1 rounded bg-indigo-100 text-indigo-700 text-xs hover:bg-indigo-200 dark:bg-indigo-800 dark:text-indigo-200 dark:hover:bg-indigo-700';
          btn.setAttribute('data-audio', a.audio);
          btn.setAttribute('data-surah', meta.number);
          btn.setAttribute('data-ayat', a.numberInSurah);
          btn.setAttribute('aria-label', `Play audio Surah ${meta.number} ayat ${a.numberInSurah}`);
          btn.textContent = '‚ñ∂ Play';
          metaRow.appendChild(btn);
        }
        ayEl.appendChild(metaRow);
        mushafContentLeft.appendChild(ayEl);
      });
    }

    pageInfoLeft.textContent = `Surah ${meta.name} (${meta.nameLocal}) ‚Äî Halaman ${pageIndex+1} / ${totalPages}`;
    surahMeta.innerHTML = `
      <div>${meta.number}. <strong>${escapeHtml(meta.name)}</strong> (${escapeHtml(meta.nameLocal)})</div>
      <div class="text-sm text-gray-600 dark:text-gray-400">Type: ${escapeHtml(meta.revelationType)} ¬∑ ${meta.numberOfAyahs} ayat</div>
    `;

    // progress
    const readAyat = Math.min((pageIndex+1)*per, meta.numberOfAyahs);
    const pct = Math.round((readAyat / meta.numberOfAyahs) * 100);
    progressText.textContent = `Surah progress: ${readAyat} / ${meta.numberOfAyahs} ayat (${pct}%)`;
    progressBar.style.width = `${pct}%`;

    // Save last pos
    const last = { surah: meta.number, pageIndex: pageIndex, time: new Date().toISOString() };
    safeSetJSON('quran_lastpos', last);
    state.lastPos = last;

  } catch(e){
    console.error(e);
    mushafContentLeft.innerHTML = `<p class="text-red-600">Gagal memuat halaman. Silakan coba lagi.</p>`;
  }
}

// ---------- Audio handling ----------
function resetPlayingButton(){
  if(state.currentPlayingBtn){
    try { state.currentPlayingBtn.textContent = '‚ñ∂ Play'; } catch(e){}
    state.currentPlayingBtn = null;
  }
}
function playSingleAudio(url, btn = null){
  try {
    if(state.audioEl.src !== url){
      state.audioEl.pause();
      state.audioEl.src = url;
    }
    state.audioEl.play().catch(err=>{
      console.error('Audio playback error', err);
      showModal('Gagal memutar audio. Pastikan browser mendukung format audio ini.');
    });
    // set UI
    resetPlayingButton();
    if(btn){ btn.textContent = '‚è∏ Playing'; state.currentPlayingBtn = btn; }
    state.audioEl.onended = ()=>{ resetPlayingButton(); };
    state.audioEl.onpause = ()=>{ /* keep UI consistent */ };
  } catch(e){
    console.error(e);
  }
}
function startAutoplayForCurrentPage(){
  state.autoplay = true;
  const btnAuto = document.getElementById('btnAutoPlay');
  btnAuto.textContent = '‚è∏ Stop';
  btnAuto.classList.add('bg-red-600');

  const meta = state.surahDataCache[state.currentSurah];
  if(!meta) { stopAutoplay(); return; }
  const per = state.ayatPerPage;
  const start = state.currentPageIndex * per;
  const chunk = meta.ayahs.slice(start, start + per);
  state.autoplayQueue = chunk.filter(a=>a.audio).map(a=>a.audio);
  state.autoplayIndex = 0;
  if(state.autoplayQueue.length===0){
    showModal('Tidak ada audio yang tersedia untuk halaman ini.');
    stopAutoplay();
    return;
  }
  playAutoplayIndex();
}
function playAutoplayIndex(){
  if(!state.autoplay) return;
  if(state.autoplayIndex >= state.autoplayQueue.length){ stopAutoplay(); return; }
  const url = state.autoplayQueue[state.autoplayIndex];
  state.audioEl.src = url;
  state.audioEl.play().catch(err => {
    console.error('Autoplay error', err);
    stopAutoplay();
    showModal('Gagal memutar audio. Autoplay dihentikan.');
  });
  state.audioEl.onended = ()=>{
    state.autoplayIndex++;
    playAutoplayIndex();
  };
}
function stopAutoplay(){
  state.autoplay = false;
  const btnAuto = document.getElementById('btnAutoPlay');
  if(btnAuto){ btnAuto.textContent = '‚ñ∂ AutoPlay'; btnAuto.classList.remove('bg-red-600'); }
  state.audioEl.pause();
  state.autoplayQueue = [];
  state.autoplayIndex = 0;
  resetPlayingButton();
}

// delegated click for play buttons (works after dynamic render)
mushafContentLeft.addEventListener('click', (e)=>{
  const btn = e.target.closest('.playAyat');
  if(!btn) return;
  const url = btn.getAttribute('data-audio');
  if(!url) return;
  // if same button and playing -> pause
  if(state.currentPlayingBtn === btn){
    state.audioEl.pause();
    resetPlayingButton();
    return;
  }
  playSingleAudio(url, btn);
});

// ---------- Search / keyword ----------
async function cariAyatSingle(){
  const sVal = document.getElementById('surah').value;
  const aVal = document.getElementById('ayat').value;
  if(!sVal || !aVal) {
    showModal('Isi surah & ayat');
    setTimeout(closeModal, 1400);
    return;
  }
  const s = Number(sVal), a = Number(aVal);
  if(isNaN(s) || s < 1 || s > 114){
    showModal('Nomor surah harus antara 1 dan 114');
    setTimeout(closeModal, 1400);
    return;
  }
  showLoader(true);
  try {
    const res = await fetch(`https://api.alquran.cloud/v1/ayah/${s}:${a}/editions/quran-uthmani,id.indonesian,ar.alafasy`);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const j = await res.json();
    if(!j || !j.data || j.data.length < 1) throw new Error('Tidak ditemukan');
    const arab = j.data[0] ? j.data[0].text : '';
    const indo = j.data[1] ? j.data[1].text : '';
    const audio = j.data[2] ? (j.data[2].audio || j.data[2].ayahs?.[0]?.audio) : null;
    output.setAttribute('aria-live','polite');
    output.innerHTML = `
      <div class="font-quran text-right mb-3">${escapeHtml(arab)}</div>
      <div class="text-sm text-gray-700 dark:text-gray-300 mb-2">${escapeHtml(indo)}</div>
      ${audio ? `<audio controls src="${escapeHtml(audio)}" class="w-full mt-2"></audio>` : ''}
      <div class="mt-2 text-xs text-gray-500 dark:text-gray-400">Surah ${s} : Ayat ${a}</div>
    `;
    pushHistory({type:'ayat', info:`Surah ${s}:${a}`, time: new Date().toLocaleString()});
  } catch(e){
    console.error(e);
    output.innerHTML = `<p class="text-red-600">Ayat tidak ditemukan atau gagal memuat.</p>`;
  } finally {
    showLoader(false);
  }
}

function debounce(fn, ms){
  return (...args)=>{
    if(state.searchDebounceTimer) clearTimeout(state.searchDebounceTimer);
    state.searchDebounceTimer = setTimeout(()=> fn(...args), ms);
  };
}

const cariKataDebounced = debounce(async ()=>{
  const kw = document.getElementById('keyword').value.trim();
  if(!kw){
    showModal('Masukkan kata kunci');
    setTimeout(closeModal, 1400);
    return;
  }
  showLoader(true);
  try {
    const res = await fetch(`https://api.alquran.cloud/v1/search/${encodeURIComponent(kw)}/all/id.indonesian`);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const j = await res.json();
    if(!j || !j.data || j.data.count === 0){
      output.innerHTML = `<p class="text-sm text-gray-500">Tidak ditemukan.</p>`;
      return;
    }
    const matches = (j.data.matches || []).slice(0,6);
    const items = matches.map(m=>`
      <div class="mb-3 p-2 border rounded dark:border-gray-600">
        <div class="text-sm text-gray-600 dark:text-gray-400">Surah ${escapeHtml(m.surah.englishName)} ‚Äî Ayat ${m.numberInSurah}</div>
        <div class="mt-1">${escapeHtml(m.text)}</div>
        <div class="mt-2"><button data-surah="${m.surah.number}" data-ayat="${m.numberInSurah}" class="openMatch px-2 py-1 rounded bg-blue-600 text-white text-xs hover:bg-blue-700">Buka</button></div>
      </div>
    `).join('');
    output.innerHTML = items;
    // attach handlers via delegation
    output.querySelectorAll('.openMatch').forEach(b=>{
      b.addEventListener('click', async (e)=>{
        const s = Number(e.currentTarget.getAttribute('data-surah'));
        const a = Number(e.currentTarget.getAttribute('data-ayat'));
        await openMushafPanel();
        state.ayatPerPage = Number(ayatPerPageInput.value) || 8;
        await loadSurahData(s);
        const page = Math.floor((a-1) / state.ayatPerPage);
        await renderMushafPage(Number(s), page);
      });
    });
    pushHistory({type:'keyword', info: kw, time: new Date().toLocaleString()});
  } catch(e){
    console.error(e);
    output.innerHTML = `<p class="text-red-600">Gagal mencari kata kunci.</p>`;
  } finally {
    showLoader(false);
  }
}, 450);

// History
function pushHistory(item){
  state.history.push(item);
  if(state.history.length > 10) state.history = state.history.slice(-10);
  safeSetJSON('quran_history', state.history);
}

// ---------- Favorites ----------
function loadFavorites(){
  state.favorites = safeGetJSON('quran_fav', []);
}
function addCurrentPageToFav(){
  const meta = state.surahDataCache[state.currentSurah];
  if(!meta) return;
  const fav = { surah: meta.number, pageIndex: state.currentPageIndex, surahName: meta.name, time: new Date().toISOString() };
  const exists = state.favorites.some(f => f.surah===fav.surah && f.pageIndex===fav.pageIndex);
  if(!exists){
    state.favorites.push(fav);
    safeSetJSON('quran_fav', state.favorites);
    showModal('Disimpan ke Favorit ‚òÖ');
    setTimeout(closeModal, 1400);
  } else {
    showModal('Sudah ada di Favorit.');
    setTimeout(closeModal, 1400);
  }
}
function openFavList(){
  if(!state.favorites || state.favorites.length===0){
    showModal('Belum ada favorit.');
    setTimeout(closeModal, 1200);
    return;
  }
  const list = state.favorites.map((f,i)=>`
    <div class="p-2 border-b dark:border-gray-600">
      <strong>${i+1}.</strong> Surah ${f.surah} (${escapeHtml(f.surahName)}) ‚Äî Hal ${f.pageIndex+1}
      <div class="text-xs text-gray-500 dark:text-gray-400">${new Date(f.time).toLocaleString()}</div>
      <div class="mt-2">
        <button data-i="${i}" class="gotoFav px-2 py-1 rounded bg-blue-600 text-white text-sm hover:bg-blue-700">Buka</button>
        <button data-i="${i}" class="delFav px-2 py-1 rounded bg-red-500 text-white text-sm hover:bg-red-600">Hapus</button>
      </div>
    </div>
  `).join('');
  showModal(`<h3 class="font-semibold mb-3">Favoritmu</h3><div class="max-h-64 overflow-auto">${list}</div>`, {allowHtml:true});
  // handlers after slight delay
  setTimeout(()=>{
    modalContent.querySelectorAll('.gotoFav').forEach(btn=>{
      btn.onclick = async (e)=>{
        const idx = Number(e.currentTarget.getAttribute('data-i'));
        const f = state.favorites[idx];
        closeModal();
        await openMushafPanel();
        await renderMushafPage(f.surah, f.pageIndex);
      };
    });
    modalContent.querySelectorAll('.delFav').forEach(btn=>{
      btn.onclick = (e)=>{
        const idx = Number(e.currentTarget.getAttribute('data-i'));
        state.favorites.splice(idx,1);
        safeSetJSON('quran_fav', state.favorites);
        closeModal();
        openFavList();
      };
    });
  }, 120);
}

// ---------- Last position ----------
async function gotoLastPosition(){
  const last = safeGetJSON('quran_lastpos', null);
  if(!last){
    showModal('Belum ada posisi terakhir.');
    setTimeout(closeModal, 1200);
    return;
  }
  await openMushafPanel();
  await renderMushafPage(last.surah, last.pageIndex);
}

// ---------- Panel open/close and controls wiring ----------
async function openMushafPanel(){
  panelCari.classList.add('hidden');
  panelMushaf.classList.remove('hidden');
  if(selectSurah.options.length === 0) await loadSurahList();
  const defaultSurah = (state.lastPos && state.lastPos.surah) ? state.lastPos.surah : 1;
  selectSurah.value = defaultSurah;
  ayatPerPageInput.value = state.ayatPerPage;
  const pageIndex = (state.lastPos && typeof state.lastPos.pageIndex === 'number') ? state.lastPos.pageIndex : 0;
  await renderMushafPage(Number(defaultSurah), pageIndex);
}

document.getElementById('openMushaf').addEventListener('click', openMushafPanel);
document.getElementById('closeMushaf').addEventListener('click', ()=>{
  panelMushaf.classList.add('hidden');
  panelCari.classList.remove('hidden');
  stopAutoplay();
});

// change handlers
selectSurah.addEventListener('change', async ()=>{
  state.ayatPerPage = Number(ayatPerPageInput.value) || 8;
  await renderMushafPage(Number(selectSurah.value), 0);
});
ayatPerPageInput.addEventListener('change', async (e)=>{
  let v = Number(e.target.value) || 8;
  if(v < 1) v = 1;
  if(v > 20) v = 20;
  e.target.value = v;
  state.ayatPerPage = v;
  // render page 0 so layout recalculates
  await renderMushafPage(state.currentSurah || 1, 0);
});

// next/prev
document.getElementById('nextPage').addEventListener('click', async ()=>{
  const meta = state.surahDataCache[state.currentSurah];
  if(!meta) return;
  const totalPages = Math.ceil(meta.numberOfAyahs / state.ayatPerPage);
  if(state.currentPageIndex + 1 >= totalPages){
    if(state.currentSurah < 114){
      const nextSurah = state.currentSurah + 1;
      selectSurah.value = nextSurah;
      await renderMushafPage(nextSurah, 0);
    } else {
      showModal('Sudah di akhir Al-Qur`an.');
      setTimeout(closeModal, 1200);
    }
  } else {
    await renderMushafPage(state.currentSurah, state.currentPageIndex+1);
  }
});
document.getElementById('prevPage').addEventListener('click', async ()=>{
  if(state.currentPageIndex > 0){
    await renderMushafPage(state.currentSurah, state.currentPageIndex-1);
  } else if(state.currentSurah > 1){
    const prevSurah = state.currentSurah - 1;
    await loadSurahData(prevSurah);
    const prevMeta = state.surahDataCache[prevSurah];
    const lastPage = Math.ceil(prevMeta.numberOfAyahs / state.ayatPerPage) - 1;
    selectSurah.value = prevSurah;
    await renderMushafPage(prevSurah, lastPage);
  } else {
    showModal('Sudah di awal Al-Qur`an.');
    setTimeout(closeModal, 1200);
  }
});

// autoplay btn
document.getElementById('btnAutoPlay').addEventListener('click', ()=>{
  if(!state.autoplay) startAutoplayForCurrentPage();
  else stopAutoplay();
});

// bookmarks/favorites
document.getElementById('bookmarkPage').addEventListener('click', addCurrentPageToFav);
document.getElementById('listFav').addEventListener('click', openFavList);
document.getElementById('btnBukaFavorit').addEventListener('click', openFavList);
document.getElementById('clearBookmarks').addEventListener('click', ()=>{
  if(confirm('Hapus semua favorit?')){
    state.favorites = [];
    localStorage.removeItem('quran_fav');
    showModal('Favorit dihapus.');
    setTimeout(closeModal, 1200);
  }
});

document.getElementById('gotoLast').addEventListener('click', gotoLastPosition);

// search wiring
document.getElementById('btnCari').addEventListener('click', cariAyatSingle);
document.getElementById('btnRandom').addEventListener('click', async ()=>{
  const s = Math.floor(Math.random()*114)+1;
  try {
    await loadSurahData(s);
    const total = state.surahDataCache[s].numberOfAyahs;
    const a = Math.floor(Math.random()*total)+1;
    document.getElementById('surah').value = s;
    document.getElementById('ayat').value = a;
    await cariAyatSingle();
  } catch(e){
    console.error(e);
    showModal('Gagal memuat surah acak.');
  }
});
document.getElementById('btnCariKata').addEventListener('click', () => cariKataDebounced());
document.getElementById('btnLihatRiwayat').addEventListener('click', ()=>{
  const h = safeGetJSON('quran_history', []);
  if(!h || h.length===0) showModal('Belum ada riwayat pencarian.');
  else {
    showModal(`<h3 class="font-semibold mb-3">Riwayat</h3><div class="max-h-64 overflow-auto text-sm">${h.map((x,i)=>`<div class="mb-2 p-2 border-b dark:border-gray-600">${i+1}. [${escapeHtml(x.time)}] ${escapeHtml(x.type)} ‚Äî ${escapeHtml(x.info)}</div>`).join('')}</div>`, {allowHtml:true});
  }
});

// open cari
document.getElementById('openCari').addEventListener('click', ()=>{
  panelMushaf.classList.add('hidden');
  panelCari.classList.remove('hidden');
  stopAutoplay();
});

// toggle translation
document.getElementById('toggleTerjemah').addEventListener('change', (e)=>{
  state.showTranslation = e.target.checked;
  renderMushafPage(state.currentSurah || 1, state.currentPageIndex || 0);
});

// keyboard nav
document.addEventListener('keydown', (e)=>{
  if(panelMushaf.classList.contains('hidden')) return;
  if(e.key === 'ArrowRight') document.getElementById('nextPage').click();
  else if(e.key === 'ArrowLeft') document.getElementById('prevPage').click();
  else if(e.key === 'Escape') closeModal();
});

// cleanup on unload
window.addEventListener('beforeunload', ()=>{
  try { state.audioEl.pause(); } catch(e){}
  // ensure cache size
  ensureCacheLimit(5);
});

// init
(function init(){
  state.history = safeGetJSON('quran_history', []);
  loadFavorites();
  state.lastPos = safeGetJSON('quran_lastpos', null);
  state.themeDark = localStorage.getItem('quran_dark') === '1';
  applyTheme();
  loadSurahList();
})();
</script>
